<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 住转 驻住转专</title>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #22c55e;
            --error: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: var(--card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 100%;
            max-width: 600px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        h1 { margin-top: 0; font-size: 1.8rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.25rem; color: #64748b; margin-bottom: 1.5rem; }
        p { line-height: 1.6; margin-bottom: 1rem; }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }

        .btn:hover { background-color: #2563eb; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .hidden { display: none !important; }

        /* Image styling */
        .scale-img {
            max-width: 100%;
            height: auto;
            max-height: 150px;
            margin: 1rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }

        /* Feedback overlays */
        .feedback {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .feedback.success { background-color: rgba(34, 197, 94, 0.9); }
        .feedback.error { background-color: rgba(239, 68, 68, 0.9); }
        .feedback.visible { opacity: 1; }

        /* Specific Degrees Styles */
        .degrees-container {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .degree-box {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #94a3b8;
        }

        .degree-box.active {
            border-color: var(--primary);
            color: var(--primary);
            background-color: #eff6ff;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        .degree-box.done {
            background-color: #dcfce7;
            border-color: var(--success);
            color: var(--success);
        }

        .status-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary);
            margin-top: 1rem;
        }

        .copyright {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2rem;
            border-top: 1px solid #e2e8f0;
            padding-top: 1rem;
        }

        .note-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .settings-container {
            margin: 1.5rem 0;
            text-align: right;
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .setting-row input, .setting-row select {
            width: auto;
            min-width: 60px;
            padding: 5px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-size: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Feedback Overlays -->
    <div id="feedback-success" class="feedback success"> !</div>
    <div id="feedback-error" class="feedback error">注转, 住 砖</div>

    <!-- View: Home -->
    <div id="view-home">
        <h1>转专 住转 驻住转专</h1>
        <p>驻拽爪 转专 住转 '专 专 爪注转 拽转 MIDI.</p>
        
        <!-- 专转 -->
        <div class="settings-container">
            <div class="setting-row">
                <label for="input-difficulty">专转 拽砖:</label>
                <select id="input-difficulty">
                    <option value="1">拽 (注 2 住 转拽)</option>
                    <option value="2" selected> (注 4 住 转拽)</option>
                    <option value="3">拽砖 ( 住转)</option>
                </select>
            </div>
            <div class="setting-row">
                <label for="input-full-reps">专转 住 :</label>
                <input type="number" id="input-full-reps" value="4" min="1">
            </div>
            <div class="setting-row">
                <label for="input-degrees-reps">专转 专转:</label>
                <input type="number" id="input-degrees-reps" value="2" min="1">
            </div>
            <div class="setting-row">
                <label for="input-chords-reps">专转 拽专:</label>
                <input type="number" id="input-chords-reps" value="3" min="1">
            </div>
        </div>

        <p> 砖驻住转专 专 砖 驻 转.</p>
        <button id="btn-start" class="btn">转 </button>
        <div class="copyright">
            The images in this app were created by Special-T and are used under the CC BY-SA 4.0 license (https://creativecommons.org/licenses/by-sa/4.0/).
        </div>
    </div>

    <!-- View: MIDI Setup -->
    <div id="view-midi-setup" class="hidden">
        <h1>拽转 专 MIDI</h1>
        <p>  转 砖 驻住转专   砖专 转拽.</p>
        <div class="note-display"></div>
        <p id="midi-status">转 拽...</p>
    </div>

    <!-- View: Root Practice -->
    <div id="view-root" class="hidden">
        <h2> 转 住</h2>
        <div id="root-instruction" class="note-display"></div>
        <img id="root-img" class="scale-img" src="" alt="Scale Signature">
        <p> 转 转 住住 (砖专砖) 砖 住.</p>
    </div>

    <!-- View: Full Scale Practice -->
    <div id="view-full-scale" class="hidden">
        <h2>转专 住 </h2>
        <h3 id="scale-title-full"></h3>
        <p> 转  7 转 砖 住 ( 住专).</p>
        <div class="status-text" id="full-scale-status">转 0 转 7 转</div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #64748b;">
            专转 砖转专: <span id="full-scale-reps">4</span>
        </div>
    </div>

    <!-- View: Specific Degrees -->
    <div id="view-degrees" class="hidden">
        <h2>转专 专转 住</h2>
        <h3 id="scale-title-degrees"></h3>
        <p> 转 专转 住 驻 住专 爪 (砖 ).</p>
        <div id="degrees-container" class="degrees-container">
            <!-- Boxes generated by JS -->
        </div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #64748b;">
            专转 砖转专: <span id="degrees-reps">2</span>
        </div>
    </div>

    <!-- View: Chords Practice -->
    <div id="view-chords" class="hidden">
        <h2>转专 拽专 (I, IV, V)</h2>
        <h3 id="scale-title-chords"></h3>
        <p> 转 拽专 爪 (3 爪 ).</p>
        
        <div id="chord-display" class="degree-box active" style="width: 100px; height: 100px; margin: 2rem auto; font-size: 2.5rem;">
            <!-- Chord Name Here -->
        </div>

        <div class="status-text" id="chords-status"></div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #64748b;">
            专转 砖转专: <span id="chords-reps"></span>
        </div>
    </div>

</div>

<script>
    /* --- Data & Constants --- */
    // Note mapping: C=0, C#=1, D=2...
    // Difficulty: 1 (Easy/0-2), 2 (Medium/3-4), 3 (Hard/5+)
    const SCALES_DATA = [
        { name: "C Major", root: 0, img: "Key_Signature_C_major.jpg", difficulty: 1 },
        { name: "F Major", root: 5, img: "Key_Signature_F_major.jpg", difficulty: 1 }, // 1 Flat
        { name: "G Major", root: 7, img: "Key_Signature_G_major.jpg", difficulty: 1 }, // 1 Sharp
        { name: "B-flat Major", root: 10, img: "Key_Signature_B-flat_major.jpg", difficulty: 1 }, // 2 Flats
        { name: "D Major", root: 2, img: "Key_Signature_D_major.jpg", difficulty: 1 }, // 2 Sharps

        { name: "E-flat Major", root: 3, img: "Key_Signature_E-flat_major.jpg", difficulty: 2 }, // 3 Flats
        { name: "A Major", root: 9, img: "Key_Signature_A_major.jpg", difficulty: 2 }, // 3 Sharps
        { name: "A-flat Major", root: 8, img: "Key_Signature_A-flat_major.jpg", difficulty: 2 }, // 4 Flats
        { name: "E Major", root: 4, img: "Key_Signature_E_major.jpg", difficulty: 2 }, // 4 Sharps

        { name: "D-flat Major", root: 1, img: "Key_Signature_D-flat_major.jpg", difficulty: 3 }, // 5 Flats
        { name: "B Major", root: 11, img: "Key_Signature_B_major.jpg", difficulty: 3 }, // 5 Sharps
        { name: "G-flat Major", root: 6, img: "Key_Signature_G-flat_major.jpg", difficulty: 3 }, // 6 Flats
        { name: "F-sharp Major", root: 6, img: "Key_Signature_F-sharp_major.jpg", difficulty: 3 }, // 6 Sharps
        { name: "C-flat Major", root: 11, img: "Key_Signature_C-flat_major.jpg", difficulty: 3 }, // 7 Flats
        { name: "C-sharp Major", root: 1, img: "Key_Signature_of_C-sharp_major.jpg", difficulty: 3 } // 7 Sharps
    ];

    // Intervals from root
    const MAJOR_INTERVALS = [0, 2, 4, 5, 7, 9, 11];
    const MINOR_INTERVALS = [0, 2, 3, 5, 7, 8, 10]; // Natural minor

    // Hebrew names for Root display (used only after identification)
    const NOTE_NAMES_HE = ["", "  / 专 ", "专", " ", "", "驻", "驻  / 住 ", "住", " ", "", "住 ", "住"];

    /* --- App State --- */
    const state = {
        currentView: 'home', // home, midi-setup, root, full-scale, degrees, chords
        currentScale: null, // Object with {root, type, img, name}
        scaleNotes: [], // Set of allowed note values (0-11)
        
        // Task specific state
        fullScale: {
            playedNotes: new Set(),
            repsLeft: 4
        },
        degrees: {
            sequence: [], // Array of numbers 1-7
            currentIndex: 0,
            repsLeft: 2
        },
        chords: {
            currentChordName: "",
            targetNotes: [], // array of 3 notes
            pressedNotes: new Set(), // accumulation of pressed keys
            repsLeft: 3
        },
        
        isProcessing: false // Lock input during feedback
    };

    /* --- DOM Elements --- */
    const views = {
        home: document.getElementById('view-home'),
        midiSetup: document.getElementById('view-midi-setup'),
        root: document.getElementById('view-root'),
        fullScale: document.getElementById('view-full-scale'),
        degrees: document.getElementById('view-degrees'),
        chords: document.getElementById('view-chords')
    };

    const feedbackEls = {
        success: document.getElementById('feedback-success'),
        error: document.getElementById('feedback-error')
    };

    /* --- Initialization --- */
    document.getElementById('btn-start').addEventListener('click', startApp);

    async function startApp() {
        if (navigator.requestMIDIAccess) {
            try {
                const midiAccess = await navigator.requestMIDIAccess();
                setupMidiInput(midiAccess);
                switchView('midiSetup');
            } catch (err) {
                alert("砖 -MIDI 砖.   砖驻驻 转 砖砖 专砖转.");
            }
        } else {
            alert("驻驻 砖  转 -Web MIDI API.");
        }
    }

    function setupMidiInput(midiAccess) {
        for (const input of midiAccess.inputs.values()) {
            input.onmidimessage = handleMidiMessage;
        }
        midiAccess.onstatechange = (e) => {
            // Re-bind if devices change
            if (e.port.type === 'input' && e.port.state === 'connected') {
                e.port.onmidimessage = handleMidiMessage;
            }
        };
    }

    function handleMidiMessage(event) {
        if (state.isProcessing) return;

        const [command, note, velocity] = event.data;
        
        // Command 144 is Note On. Ignore if velocity is 0 (some devices send note on vel 0 as note off)
        if ((command & 0xf0) === 144 && velocity > 0) {
            const normalizedNote = note % 12; // Ignore octave
            processInput(normalizedNote);
        }
    }

    /* --- Core Logic --- */

    function processInput(note) {
        switch (state.currentView) {
            case 'midiSetup':
                // Any note works
                showSuccess("爪!", () => generateNewTask());
                break;

            case 'root':
                checkRootTask(note);
                break;

            case 'fullScale':
                checkFullScaleTask(note);
                break;

            case 'degrees':
                checkDegreesTask(note);
                break;
            
            case 'chords':
                checkChordsTask(note);
                break;
        }
    }

    function generateNewTask() {
        // 拽专转 专转 拽砖
        const difficulty = parseInt(document.getElementById('input-difficulty').value) || 2;

        // 住 住转 驻 专
        const filteredScales = SCALES_DATA.filter(s => s.difficulty <= difficulty);
        
        // 专 拽专转 转 专砖 住转
        const baseScale = filteredScales[Math.floor(Math.random() * filteredScales.length)];
        
        // 2. Decide Major or Minor (50/50)
        const isMajor = Math.random() > 0.5;
        
        // 3. Calculate actual root and notes
        let actualRoot;
        let scaleTypeStr;
        let intervals;

        if (isMajor) {
            actualRoot = baseScale.root;
            scaleTypeStr = "'专";
            intervals = MAJOR_INTERVALS;
        } else {
            // Relative Minor: Major Root + 9 semitones (or -3)
            // Example: C Major (0) -> A Minor (9)
            actualRoot = (baseScale.root + 9) % 12;
            scaleTypeStr = "专";
            intervals = MINOR_INTERVALS;
        }

        // 4. Generate valid note set for this scale
        const validNotes = intervals.map(interval => (actualRoot + interval) % 12);

        state.currentScale = {
            name: baseScale.name, // Image name remains based on Major key signature
            img: `pic/${baseScale.img}`,
            root: actualRoot,
            typeStr: scaleTypeStr,
            isMajor: isMajor
        };
        state.scaleNotes = validNotes;

        // Start Root Task
        setupRootView();
    }

    /* --- Task: Root --- */
    function setupRootView() {
        const title = ` 住 ? (${state.currentScale.typeStr})`;
        document.getElementById('root-instruction').innerText = title;
        document.getElementById('root-img').src = state.currentScale.img;
        switchView('root');
    }

    function checkRootTask(note) {
        if (note === state.currentScale.root) {
            showSuccess(" , 转砖 ", setupFullScaleView);
        } else {
            showError("注转, 住 砖", null); // Stay on page
        }
    }

    /* --- Task: Full Scale --- */
    function setupFullScaleView() {
        const repsInput = parseInt(document.getElementById('input-full-reps').value);
        state.fullScale.repsLeft = (repsInput && repsInput > 0) ? repsInput : 4;
        
        resetFullScaleRound();
        
        const title = `住 ${nameToHebrew(state.currentScale.root)} ${state.currentScale.typeStr}`;
        document.getElementById('scale-title-full').innerText = title;
        updateFullScaleUI();
        switchView('fullScale');
    }

    function resetFullScaleRound() {
        state.fullScale.playedNotes.clear();
        updateFullScaleUI();
    }

    function updateFullScaleUI() {
        const count = state.fullScale.playedNotes.size;
        document.getElementById('full-scale-status').innerText = `转 ${count} 转 7 转 住`;
        document.getElementById('full-scale-reps').innerText = state.fullScale.repsLeft;
    }

    function checkFullScaleTask(note) {
        // Check if note is in scale
        if (state.scaleNotes.includes(note)) {
            state.fullScale.playedNotes.add(note);
            updateFullScaleUI();

            if (state.fullScale.playedNotes.size === 7) {
                // Round Complete
                state.fullScale.repsLeft--;
                updateFullScaleUI();

                if (state.fullScale.repsLeft > 0) {
                    showSuccess("驻, 注 " + state.fullScale.repsLeft + " 驻注", () => {
                        resetFullScaleRound();
                    }, 800); // Shorter delay for intermediate success
                } else {
                    showSuccess(" !", setupDegreesView);
                }
            }
        } else {
            // Wrong note
            showError("注转, 住 砖", () => {
                const repsInput = parseInt(document.getElementById('input-full-reps').value);
                state.fullScale.repsLeft = (repsInput && repsInput > 0) ? repsInput : 4;
                resetFullScaleRound();
                updateFullScaleUI();
            });
        }
    }

    /* --- Task: Specific Degrees --- */
    function setupDegreesView() {
        const repsInput = parseInt(document.getElementById('input-degrees-reps').value);
        state.degrees.repsLeft = (repsInput && repsInput > 0) ? repsInput : 2;

        const title = `住 ${nameToHebrew(state.currentScale.root)} ${state.currentScale.typeStr}`;
        document.getElementById('scale-title-degrees').innerText = title;
        startDegreesRound();
        switchView('degrees');
    }

function startDegreesRound() {
        // 爪专转 专砖:  住驻专 驻注 驻注 (注 1 砖驻注 驻注 转 专砖 专砖转)
        // 住: -1 砖 转住祝 转 住祝 专砖   住 -1
        const nums = [1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7];

        // 注专 (Shuffle) 砖 专砖
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }

        // 专砖: 专 专  转 1
        nums.push(1);

        state.degrees.sequence = nums;
        state.degrees.currentIndex = 0;
        renderDegreesUI();
    }
    function renderDegreesUI() {
        const container = document.getElementById('degrees-container');
        container.innerHTML = '';
        document.getElementById('degrees-reps').innerText = state.degrees.repsLeft;

        state.degrees.sequence.forEach((num, index) => {
            const div = document.createElement('div');
            div.className = 'degree-box';
            div.innerText = num;
            
            if (index < state.degrees.currentIndex) {
                div.classList.add('done');
            } else if (index === state.degrees.currentIndex) {
                div.classList.add('active');
            }
            container.appendChild(div);
        });
    }

    function checkDegreesTask(note) {
        // Strategy: state.scaleNotes was generated via intervals.
        // So index 0 = Degree 1 (Root), Index 1 = Degree 2, etc.
        
        const currentTargetDegree = state.degrees.sequence[state.degrees.currentIndex];
        const expectedNote = state.scaleNotes[currentTargetDegree - 1]; // 1-based to 0-based

        if (note === expectedNote) {
            state.degrees.currentIndex++;
            renderDegreesUI();

            if (state.degrees.currentIndex >= 7) {
                // Round complete
                state.degrees.repsLeft--;
                
                if (state.degrees.repsLeft > 0) {
                    showSuccess("驻!", () => {
                        startDegreesRound();
                    }, 800);
                } else {
                    // 注专 住转 注 注专 拽专
                    showSuccess(" ! 注专 拽专...", () => {
                        setupChordsView();
                    });
                }
            }
        } else {
            showError("注转, 住 砖", () => {
                const repsInput = parseInt(document.getElementById('input-degrees-reps').value);
                state.degrees.repsLeft = (repsInput && repsInput > 0) ? repsInput : 2;
                startDegreesRound();
            });
        }
    }

function setupChordsView() {
        const repsInput = parseInt(document.getElementById('input-chords-reps').value);
        state.chords.repsLeft = (repsInput && repsInput > 0) ? repsInput : 3;
        
        // 砖专转 住 专转 拽专 ( 转 转 住 专砖)
        state.chords.totalReps = state.chords.repsLeft;
        // 驻住 专 拽专 拽
        state.chords.lastDegree = null;

        const title = `住 ${nameToHebrew(state.currentScale.root)} ${state.currentScale.typeStr}`;
        document.getElementById('scale-title-chords').innerText = title;
        
        generateRandomChord();
        switchView('chords');
    }

function generateRandomChord() {
        let degree;
        
        // 拽:   拽专 专砖 (驻 住 专转)  专 (砖专 1)?
        //   - 专 转 专 1
        const isFirst = (state.chords.repsLeft === state.chords.totalReps);
        const isLast = (state.chords.repsLeft === 1);

        if (isFirst || isLast) {
            degree = 1; 
        } else {
            // 驻砖专转 专: 住驻 转 6 (VI) 专砖
            const options = [1, 4, 5, 6];
            
            // 注转 驻转 专爪祝: 住 爪 转 专 砖 专注
            const available = options.filter(d => d !== state.chords.lastDegree);
            
            // 专 拽专转 驻砖专转 砖转专
            degree = available[Math.floor(Math.random() * available.length)];
        }
        
        // 砖专转 专 转 住 
        state.chords.lastDegree = degree;
        
        // --- 砖 转 (拽 拽专转 砖专转,  注转  注专 专 6) ---
        // 专转 专 拽住 住住 (0-based)
        const rootIndex = degree - 1; 
        
        const n1 = state.scaleNotes[rootIndex];
        const n2 = state.scaleNotes[(rootIndex + 2) % 7];
        const n3 = state.scaleNotes[(rootIndex + 4) % 7];
        
        state.chords.targetNotes = [n1, n2, n3];
        
        // 拽注转 砖 拽专 转爪 - 住驻转 转 -VI
        let roman = 'I';
        if (degree === 4) roman = 'IV';
        if (degree === 5) roman = 'V';
        if (degree === 6) roman = 'VI';

        state.chords.currentChordName = roman;
        
        // 驻住 拽 砖转砖
        state.chords.pressedNotes.clear();
        
        updateChordsUI();
    }
    function updateChordsUI() {
        document.getElementById('chord-display').innerText = state.chords.currentChordName;
        document.getElementById('chords-reps').innerText = state.chords.repsLeft;
        document.getElementById('chords-status').innerText = " 转 拽专";
    }

function checkChordsTask(note) {
    // 拽  转 砖抓 砖 拽专 拽砖
    if (!state.chords.targetNotes.includes(note)) {
        // 转 砖 - 爪转 砖 驻住
        showError("注转, 住 砖", () => {
            // 驻住 住驻专 专转 爪 转转
            const repsInput = parseInt(document.getElementById('input-chords-reps').value);
            state.chords.repsLeft = (repsInput && repsInput > 0) ? repsInput : 3;
            
            // 爪专 拽专 砖 转 砖
            generateRandomChord();
        });
        return; // 爪 驻拽爪
    }
    
    //  转  - 住驻 住
    state.chords.pressedNotes.add(note);
    
    // 拽   3 转  爪
    const allNotesPressed = state.chords.targetNotes.every(target => 
        state.chords.pressedNotes.has(target)
    );

    if (allNotesPressed) {
        state.chords.repsLeft--;
        
        if (state.chords.repsLeft > 0) {
            showSuccess("爪!", () => {
                generateRandomChord();
            }, 600);
        } else {
            showSuccess("住转 转 住 爪!", () => {
                 generateNewTask();
            });
        }
    }
}

    /* --- Utilities --- */

    function switchView(viewName) {
        state.currentView = viewName;
        Object.values(views).forEach(el => el.classList.add('hidden'));
        views[viewName].classList.remove('hidden');
    }

    function showSuccess(msg, callback, duration = 1000) {
        state.isProcessing = true;
        const el = feedbackEls.success;
        el.innerText = msg;
        el.classList.add('visible');
        setTimeout(() => {
            el.classList.remove('visible');
            state.isProcessing = false;
            if (callback) callback();
        }, duration);
    }

    function showError(msg, callback, duration = 1000) {
        state.isProcessing = true;
        const el = feedbackEls.error;
        el.innerText = msg;
        el.classList.add('visible');
        setTimeout(() => {
            el.classList.remove('visible');
            state.isProcessing = false;
            if (callback) callback();
        }, duration);
    }

    // Helper to give rough Hebrew name for Root Note (Simplification)
    function nameToHebrew(noteVal) {
        // noteVal 0-11
        // Mapping Logic:
        // 0: C, 1: C#/Db, 2: D...
        const map = {
            0: "", 1: "# / 专b", 2: "专", 3: "b", 4: "",
            5: "驻", 6: "驻# / 住b", 7: "住", 8: "b", 9: "",
            10: "住b", 11: "住 / b"
        };
        return map[noteVal] || "?";
    }

</script>

</body>
</html>
